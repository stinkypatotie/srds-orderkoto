<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>SRDS Order Manager</title>
    <meta name="description" content="Sir Ramos Drugstore Order Management System">
    <meta name="theme-color" content="#2563eb">
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        * { box-sizing: border-box; }
        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            max-width: 90%;
        }
        .install-prompt.show {
            display: block;
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Install Prompt -->
    <div id="installPrompt" class="install-prompt">
        <div class="flex items-center gap-3">
            <div class="text-2xl">üì±</div>
            <div class="flex-1">
                <div class="font-bold">Install SRDS Order Manager</div>
                <div class="text-sm text-gray-600">Add to home screen for easy access</div>
            </div>
            <button onclick="installApp()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium">Install</button>
            <button onclick="dismissInstall()" class="text-gray-500">‚úï</button>
        </div>
    </div>

    <div id="root">Loading...</div>

    <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed:', err));
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Check if user has previously dismissed
            const dismissed = localStorage.getItem('install-dismissed');
            if (!dismissed) {
                setTimeout(() => {
                    document.getElementById('installPrompt').classList.add('show');
                }, 3000);
            }
        });

        function installApp() {
            const promptEl = document.getElementById('installPrompt');
            promptEl.classList.remove('show');
            
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('App installed');
                    }
                    deferredPrompt = null;
                });
            }
        }

        function dismissInstall() {
            document.getElementById('installPrompt').classList.remove('show');
            localStorage.setItem('install-dismissed', 'true');
        }

        console.log('Script starting...');
        
        // Format Peso
        function formatPeso(amount) {
            return '‚Ç±' + parseFloat(amount).toLocaleString('en-PH', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // State
        let products = [];
        let orderItems = [];
        let hiddenProductIds = [];
        let telegramToken = '';
        let chatId = '';
        let searchItem = '';
        let searchCategory = '';
        let stockFilter = 'all';
        let showSettings = false;
        let showDeleteConfirm = false;
        let showOrderConfirm = false;
        let showMobileCart = false;

        // Auto-load Excel from GitHub
        async function autoLoadFromGitHub() {
            // Only load if no products exist yet
            if (products.length > 0) return;
            
            try {
                // Replace with your actual GitHub raw file URL
                const githubFileUrl = 'https://raw.githubusercontent.com/YOUR-USERNAME/YOUR-REPO/main/products.xlsx';
                
                const response = await fetch(githubFileUrl);
                if (!response.ok) {
                    console.log('No default products file found');
                    return;
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(sheet);

                const imported = jsonData.map((row, idx) => ({
                    id: Date.now() + idx,
                    name: row.NAME || row.Name || row.name || '',
                    category: row.CATEGORY || row.Category || row.category || '',
                    cost: parseFloat(row.COST || row.Cost || row.cost || 0),
                    inStock: parseInt(row['In stock [Sir Ramos Drugstore - Mabalas Balas]'] || row.inStock || 0),
                    lowStock: parseInt(row['Low stock [Sir Ramos Drugstore - Mabalas Balas]'] || row.lowStock || 0)
                }));

                products = imported;
                saveProducts();
                console.log(`Auto-loaded ${imported.length} products from GitHub`);
            } catch (error) {
                console.log('Could not auto-load products:', error);
            }
        }

        // Load from localStorage
        function loadData() {
            try {
                const stored = localStorage.getItem('orderapp-products');
                if (stored) {
                    products = JSON.parse(stored);
                }
                
                const settings = localStorage.getItem('orderapp-settings');
                if (settings) {
                    const data = JSON.parse(settings);
                    telegramToken = data.telegramToken || '';
                    chatId = data.chatId || '';
                }

                const hidden = localStorage.getItem('orderapp-hidden');
                if (hidden) {
                    hiddenProductIds = JSON.parse(hidden);
                }
            } catch (error) {
                console.log('No stored data found');
            }
        }

        // Save to localStorage
        function saveProducts() {
            localStorage.setItem('orderapp-products', JSON.stringify(products));
        }

        // Save hidden items
        function saveHidden() {
            localStorage.setItem('orderapp-hidden', JSON.stringify(hiddenProductIds));
        }

        // Save settings
        function saveSettings() {
            try {
                localStorage.setItem('orderapp-settings', JSON.stringify({ telegramToken, chatId }));
                showSettings = false;
                alert('Settings saved!');
                render();
            } catch (error) {
                console.error('Settings save error:', error);
            }
        }

        // Toggle hide product
        function toggleHideProduct(productId) {
            const index = hiddenProductIds.indexOf(productId);
            if (index > -1) {
                hiddenProductIds.splice(index, 1);
            } else {
                hiddenProductIds.push(productId);
            }
            saveHidden();
            render();
        }

        // Show all hidden products
        function showAllProducts() {
            hiddenProductIds = [];
            saveHidden();
            render();
        }

        // Import from Excel
        function handleFileImport(file) {
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(sheet);

                    const imported = jsonData.map((row, idx) => ({
                        id: Date.now() + idx,
                        name: row.NAME || row.Name || row.name || '',
                        category: row.CATEGORY || row.Category || row.category || '',
                        cost: parseFloat(row.COST || row.Cost || row.cost || 0),
                        inStock: parseInt(row['In stock [Sir Ramos Drugstore - Mabalas Balas]'] || row.inStock || 0),
                        lowStock: parseInt(row['Low stock [Sir Ramos Drugstore - Mabalas Balas]'] || row.lowStock || 0)
                    }));

                    products = [...products, ...imported];
                    saveProducts();
                    alert(`Imported ${imported.length} items successfully!`);
                    render();
                } catch (error) {
                    console.error('Import error:', error);
                    alert('Error importing file: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Delete all products
        function deleteAllProducts() {
            products = [];
            saveProducts();
            showDeleteConfirm = false;
            alert('Database cleared successfully!');
            render();
        }

        // Export to Excel
        function exportToExcel() {
            if (products.length === 0) {
                alert('No products to export');
                return;
            }

            const exportData = products.map(p => ({
                'NAME': p.name,
                'CATEGORY': p.category,
                'COST': p.cost,
                'In stock [Sir Ramos Drugstore - Mabalas Balas]': p.inStock,
                'Low stock [Sir Ramos Drugstore - Mabalas Balas]': p.lowStock
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Products');
            XLSX.writeFile(wb, `SRDS_Products_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // Add to order
        function addToOrder(product) {
            const inputId = 'qty_' + product.id;
            const inputElement = document.getElementById(inputId);
            const quantity = inputElement ? parseInt(inputElement.value) || 0 : (product.lowStock || 0) * 2;
            
            if (quantity <= 0) {
                alert('Please enter a valid quantity');
                return;
            }
            
            const existing = orderItems.find(item => item.id === product.id);
            
            if (existing) {
                existing.quantity += quantity;
            } else {
                orderItems.push({ ...product, quantity: quantity });
            }
            
            // Hide the product after adding to cart
            if (!hiddenProductIds.includes(product.id)) {
                hiddenProductIds.push(product.id);
                saveHidden();
            }
            
            render();
        }

        // Update order quantity
        function updateOrderQuantity(id, quantity) {
            const item = orderItems.find(item => item.id == id);
            if (!item) return;
            
            if (quantity <= 0) {
                orderItems = orderItems.filter(item => item.id != id);
            } else {
                item.quantity = quantity;
            }
            render();
        }

        // Remove from order
        function removeFromOrder(id) {
            orderItems = orderItems.filter(item => item.id != id);
            render();
        }

        // Get subtotal
        function getSubtotal(item) {
            return item.cost * item.quantity;
        }

        // Get grand total
        function getGrandTotal() {
            return orderItems.reduce((sum, item) => sum + getSubtotal(item), 0);
        }

        // Send to Telegram
        async function sendToTelegram() {
            if (!telegramToken || !chatId) {
                alert('Please configure Telegram settings first');
                showSettings = true;
                render();
                return;
            }

            if (orderItems.length === 0) {
                alert('Order is empty');
                return;
            }

            let message = 'üõí *New Order*\n\n';
            orderItems.forEach(item => {
                message += `${item.quantity}pc(s) - ${item.name}\n`;
            });

            try {
                const response = await fetch(`https://api.telegram.org/bot${telegramToken}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: message,
                        parse_mode: 'Markdown'
                    })
                });

                if (response.ok) {
                    alert('Order sent to Telegram!');
                    orderItems = [];
                    showOrderConfirm = false;
                    render();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.description || 'Failed to send'}`);
                }
            } catch (error) {
                alert('Network error. Check your connection.');
            }
        }

        // Filter products
        function getFilteredProducts() {
            return products.filter(product => {
                // Filter out hidden products
                if (hiddenProductIds.includes(product.id)) {
                    return false;
                }

                const matchesItem = product.name.toLowerCase().includes(searchItem.toLowerCase());
                const matchesCategory = product.category.toLowerCase().includes(searchCategory.toLowerCase());
                
                let matchesStock = true;
                const inStock = product.inStock || 0;
                const lowStock = product.lowStock || 0;
                
                if (stockFilter === 'low') {
                    matchesStock = inStock > 0 && inStock <= lowStock;
                } else if (stockFilter === 'out') {
                    matchesStock = inStock === 0;
                } else if (stockFilter === 'in') {
                    matchesStock = inStock > lowStock;
                }
                
                return matchesItem && matchesCategory && matchesStock;
            });
        }

        // Get stock status
        function getStockStatus(product) {
            const inStock = product.inStock || 0;
            const lowStock = product.lowStock || 0;
            
            if (inStock === 0) {
                return { label: 'OUT OF STOCK', color: 'bg-red-100 text-red-700' };
            } else if (inStock <= lowStock) {
                return { label: `LOW STOCK (${inStock})`, color: 'bg-yellow-100 text-yellow-700' };
            } else {
                return { label: `In Stock (${inStock})`, color: 'bg-green-100 text-green-700' };
            }
        }

        // Group by category
        function groupByCategory(products) {
            const grouped = {};
            products.forEach(product => {
                const category = product.category || 'Uncategorized';
                if (!grouped[category]) {
                    grouped[category] = [];
                }
                grouped[category].push(product);
            });

            return Object.keys(grouped).sort().map(category => ({
                category,
                items: grouped[category]
            }));
        }

        // Handle search
        function handleSearch(value, type) {
            if (type === 'item') {
                searchItem = value;
            } else {
                searchCategory = value;
            }
            render();
        }

        // Render cart summary
        function renderCartSummary() {
            return `
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-lg font-bold">üõí Order Summary (${orderItems.length} items)</h2>
                        ${window.innerWidth < 1024 ? `<button onclick="showMobileCart = false; render();" class="text-gray-600">‚úï</button>` : ''}
                    </div>
                    
                    ${orderItems.length === 0 ? '<div class="text-center text-gray-500 py-8">No items in order yet</div>' : `
                        <div class="space-y-2 max-h-[400px] overflow-y-auto mb-4">
                            ${orderItems.map(item => `
                                <div class="border rounded p-3">
                                    <div class="flex justify-between items-start mb-2">
                                        <div class="flex-1">
                                            <h4 class="font-bold">${item.name}</h4>
                                            <p class="text-sm text-gray-600">${item.category}</p>
                                            <p class="text-sm text-blue-600">${formatPeso(item.cost)} each</p>
                                        </div>
                                        <button onclick="removeFromOrder('${item.id}');" class="text-red-600 p-1">‚úï</button>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-2">
                                            <button onclick="updateOrderQuantity('${item.id}', ${item.quantity - 1});" class="w-8 h-8 bg-gray-200 rounded font-bold">-</button>
                                            <input type="number" value="${item.quantity}" onchange="updateOrderQuantity('${item.id}', parseInt(this.value) || 1);" min="1" class="w-16 text-center border rounded p-1" />
                                            <button onclick="updateOrderQuantity('${item.id}', ${item.quantity + 1});" class="w-8 h-8 bg-gray-200 rounded font-bold">+</button>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-xs text-gray-500">Subtotal</p>
                                            <p class="font-bold text-blue-600">${formatPeso(getSubtotal(item))}</p>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="border-t pt-4">
                            <div class="flex justify-between items-center mb-4">
                                <span class="text-xl font-bold">Grand Total:</span>
                                <span class="text-2xl font-bold text-blue-600">${formatPeso(getGrandTotal())}</span>
                            </div>
                            <button onclick="showOrderConfirm = true; render();" class="w-full bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700">
                                üì§ Review & Send Order
                            </button>
                        </div>
                    `}
                </div>
            `;
        }

        // Render
        function render() {
            console.log('Rendering...');
            const filteredProducts = getFilteredProducts();
            const groupedProducts = groupByCategory(filteredProducts);
            const isMobile = window.innerWidth < 1024;

            const app = document.getElementById('root');
            
            app.innerHTML = `
                <!-- Header -->
                <div class="bg-blue-600 text-white p-4 sticky top-0 z-10 shadow-lg">
                    <div class="flex justify-between items-center">
                        <h1 class="text-xl font-bold">Sir Ramos Drugstore - Order Manager</h1>
                        <div class="flex gap-2">
                            ${isMobile && orderItems.length > 0 ? `
                                <button onclick="showMobileCart = true; render();" class="p-2 bg-blue-700 rounded-lg relative">
                                    üõí
                                    <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">${orderItems.length}</span>
                                </button>
                            ` : ''}
                            <button onclick="showSettings = true; render();" class="p-2 bg-blue-700 rounded-lg">‚öôÔ∏è</button>
                        </div>
                    </div>
                </div>

                <!-- Mobile Cart Modal -->
                ${isMobile && showMobileCart ? `
                    <div class="fixed inset-0 bg-white z-20 overflow-y-auto">
                        <div class="p-4">
                            ${renderCartSummary()}
                        </div>
                    </div>
                ` : ''}

                <!-- Settings Modal -->
                ${showSettings ? `
                    <div class="fixed inset-0 bg-black bg-opacity-50 z-20 flex items-center justify-center p-4">
                        <div class="bg-white rounded-lg p-6 max-w-md w-full">
                            <h2 class="text-xl font-bold mb-4">Telegram Settings</h2>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">Bot Token</label>
                                    <input id="tokenInput" type="text" value="${telegramToken}" placeholder="123456:ABC-DEF..." class="w-full p-2 border rounded" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Chat ID</label>
                                    <input id="chatInput" type="text" value="${chatId}" placeholder="Your chat ID" class="w-full p-2 border rounded" />
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="telegramToken = document.getElementById('tokenInput').value; chatId = document.getElementById('chatInput').value; saveSettings();" class="flex-1 bg-blue-600 text-white p-2 rounded-lg">Save</button>
                                    <button onclick="showSettings = false; render();" class="flex-1 bg-gray-300 p-2 rounded-lg">Cancel</button>
                                </div>
                            </div>
                        </div>
                    </div>
                ` : ''}

                <!-- Delete Confirm Modal -->
                ${showDeleteConfirm ? `
                    <div class="fixed inset-0 bg-black bg-opacity-50 z-20 flex items-center justify-center p-4">
                        <div class="bg-white rounded-lg p-6 max-w-md w-full">
                            <h2 class="text-xl font-bold mb-4 text-red-600">‚ö†Ô∏è Delete Database</h2>
                            <p class="mb-6">Are you sure you want to delete all ${products.length} products?</p>
                            <div class="flex gap-2">
                                <button onclick="deleteAllProducts();" class="flex-1 bg-red-600 text-white p-2 rounded-lg font-bold">Yes, Delete All</button>
                                <button onclick="showDeleteConfirm = false; render();" class="flex-1 bg-gray-300 p-2 rounded-lg">Cancel</button>
                            </div>
                        </div>
                    </div>
                ` : ''}

                <!-- Order Confirmation Modal -->
                ${showOrderConfirm ? `
                    <div class="fixed inset-0 bg-black bg-opacity-50 z-20 flex items-center justify-center p-4">
                        <div class="bg-white rounded-lg p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                            <h2 class="text-xl font-bold mb-4">üìã Confirm Your Order</h2>
                            <div class="space-y-2 mb-6">
                                ${orderItems.map(item => `
                                    <div class="border rounded p-3">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <h4 class="font-bold">${item.name}</h4>
                                                <p class="text-sm text-gray-600">${item.category}</p>
                                            </div>
                                            <div class="text-right">
                                                <p class="font-bold">Qty: ${item.quantity}</p>
                                                <p class="text-sm text-gray-600">${formatPeso(item.cost)} each</p>
                                                <p class="text-blue-600 font-bold">${formatPeso(getSubtotal(item))}</p>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="border-t pt-4 mb-6">
                                <div class="flex justify-between items-center">
                                    <span class="text-xl font-bold">Grand Total:</span>
                                    <span class="text-2xl font-bold text-blue-600">${formatPeso(getGrandTotal())}</span>
                                </div>
                            </div>
                            <div class="bg-gray-100 p-4 rounded mb-6">
                                <h3 class="font-bold mb-2">Message Preview:</h3>
                                <pre class="text-sm whitespace-pre-wrap">üõí New Order

${orderItems.map(item => `${item.quantity}pc(s) - ${item.name}`).join('\n')}</pre>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="sendToTelegram();" class="flex-1 bg-blue-600 text-white p-3 rounded-lg font-bold">‚úÖ Confirm & Send to Telegram</button>
                                <button onclick="showOrderConfirm = false; render();" class="flex-1 bg-gray-300 p-2 rounded-lg">Cancel</button>
                            </div>
                        </div>
                    </div>
                ` : ''}

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 p-4">
                    <!-- Left Panel -->
                    <div class="space-y-4">
                        <div class="bg-white rounded-lg shadow p-4 space-y-3">
                            <label class="flex items-center gap-2 p-3 bg-green-50 border-2 border-green-500 rounded-lg cursor-pointer hover:bg-green-100">
                                üì§ <span class="text-green-700 font-medium">Import from Excel</span>
                                <input type="file" accept=".xlsx,.xls" onchange="handleFileImport(this.files[0]); this.value='';" class="hidden" />
                            </label>
                            <button onclick="exportToExcel();" class="w-full flex items-center justify-center gap-2 p-3 bg-blue-50 border-2 border-blue-500 rounded-lg hover:bg-blue-100">
                                üì• <span class="text-blue-700 font-medium">Export to Excel</span>
                            </button>
                            ${hiddenProductIds.length > 0 ? `
                                <button onclick="showAllProducts();" class="w-full flex items-center justify-center gap-2 p-3 bg-purple-50 border-2 border-purple-500 rounded-lg hover:bg-purple-100">
                                    üëÅÔ∏è <span class="text-purple-700 font-medium">Show Hidden Items (${hiddenProductIds.length})</span>
                                </button>
                            ` : ''}
                            <button onclick="showDeleteConfirm = true; render();" class="w-full flex items-center justify-center gap-2 p-3 bg-red-50 border-2 border-red-500 rounded-lg hover:bg-red-100">
                                üóëÔ∏è <span class="text-red-700 font-medium">Delete All Products</span>
                            </button>
                        </div>

                        <!-- Filters -->
                        <div class="bg-white rounded-lg shadow p-4 space-y-3">
                            <h3 class="font-bold">üîç Search & Filter</h3>
                            <input type="text" placeholder="Search by Item Name..." value="${searchItem}" onblur="handleSearch(this.value, 'item');" onkeypress="if(event.key==='Enter') handleSearch(this.value, 'item');" class="w-full p-2 border rounded" />
                            <input type="text" placeholder="Search by Category..." value="${searchCategory}" onblur="handleSearch(this.value, 'category');" onkeypress="if(event.key==='Enter') handleSearch(this.value, 'category');" class="w-full p-2 border rounded" />
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Stock Level</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <button onclick="stockFilter = 'all'; render();" class="p-2 rounded text-sm ${stockFilter === 'all' ? 'bg-blue-600 text-white' : 'bg-gray-200'}">All Items</button>
                                    <button onclick="stockFilter = 'in'; render();" class="p-2 rounded text-sm ${stockFilter === 'in' ? 'bg-green-600 text-white' : 'bg-gray-200'}">In Stock</button>
                                    <button onclick="stockFilter = 'low'; render();" class="p-2 rounded text-sm ${stockFilter === 'low' ? 'bg-yellow-600 text-white' : 'bg-gray-200'}">Low Stock</button>
                                    <button onclick="stockFilter = 'out'; render();" class="p-2 rounded text-sm ${stockFilter === 'out' ? 'bg-red-600 text-white' : 'bg-gray-200'}">Out of Stock</button>
                                </div>
                            </div>

                            ${(searchItem || searchCategory || stockFilter !== 'all') ? `
                                <button onclick="searchItem = ''; searchCategory = ''; stockFilter = 'all'; render();" class="w-full bg-gray-200 text-gray-700 p-2 rounded-lg text-sm">Clear All Filters</button>
                            ` : ''}
                        </div>

                        <!-- Products -->
                        <div class="bg-white rounded-lg shadow p-4">
                            <h2 class="text-lg font-bold mb-3">üì¶ Items (${filteredProducts.length})</h2>
                            <div class="space-y-4 max-h-[600px] overflow-y-auto">
                                ${products.length === 0 ? `
                                    <div class="text-center text-gray-500 py-8">
                                        <div class="text-4xl mb-2">üìã</div>
                                        <p>No products in database</p>
                                        <p class="text-sm mt-2">Import an Excel file to get started</p>
                                    </div>
                                ` : groupedProducts.length === 0 ? '<div class="text-center text-gray-500 py-8">No products match your filters</div>' :
                                    groupedProducts.map(group => `
                                        <div>
                                            <h3 class="text-sm font-bold bg-gray-100 p-2 rounded mb-2">üìÅ ${group.category}</h3>
                                            <div class="space-y-2">
                                                ${group.items.map(product => {
                                                    const status = getStockStatus(product);
                                                    return `
                                                        <div class="border rounded p-3">
                                                            <div class="flex justify-between items-start mb-2">
                                                                <div class="flex-1">
                                                                    <h4 class="font-bold">${product.name}</h4>
                                                                    <p class="text-sm text-gray-600">${product.category}</p>
                                                                    <p class="text-sm text-gray-500">Suggested: ${(product.lowStock || 0) * 2} pc(s)</p>
                                                                    <p class="text-lg font-bold text-blue-600">${formatPeso(product.cost)}</p>
                                                                </div>
                                                                <div class="flex flex-col gap-1 items-end">
                                                                    <span class="px-2 py-1 text-xs rounded font-bold ${status.color}">${status.label}</span>
                                                                    <button onclick="toggleHideProduct(${product.id});" class="text-xs text-gray-500 hover:text-red-600 underline">Hide</button>
                                                                </div>
                                                            </div>
                                                            <div class="flex gap-2 items-center">
                                                                <input type="number" id="qty_${product.id}" value="${(product.lowStock || 0) * 2}" min="1" class="w-20 p-2 border rounded text-center" />
                                                                <button onclick='addToOrder(${JSON.stringify(product).replace(/'/g, "\\'")});' class="flex-1 bg-blue-600 text-white p-2 rounded hover:bg-blue-700">
                                                                    Add to Order
                                                                </button>
                                                            </div>
                                                        </div>
                                                    `;
                                                }).join('')}
                                            </div>
                                        </div>
                                    `).join('')
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Right Panel - Desktop Only -->
                    ${!isMobile ? `
                        <div class="space-y-4">
                            <div class="sticky top-20">
                                ${renderCartSummary()}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            console.log('Render complete');
        }

        // Initialize
        console.log('Initializing...');
        loadData();
        
        // Auto-load products from GitHub if none exist
        autoLoadFromGitHub().then(() => {
            render();
        });
        
        // Re-render on resize to handle mobile/desktop transitions
        window.addEventListener('resize', () => {
            const wasMobile = showMobileCart;
            if (window.innerWidth >= 1024 && wasMobile) {
                showMobileCart = false;
            }
            render();
        });
        
        console.log('Initialization complete');
    </script>
</body>
</html>